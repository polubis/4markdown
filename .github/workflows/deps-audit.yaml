name: Vulnerabilities In Dependencies

on:
  pull_request:
    branches: ['develop']

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3

      - name: Audit for Vulnerabilities
        run: npm audit --audit-level=low
        continue-on-error: true

      - name: Check for Critical Vulnerabilities and Handle Ignored List
        run: |
          # Define the vulnerabilities to ignore
          IGNORE_LIST=( "CVE-XXXX-XXXX" "CVE-YYYY-YYYY" )

          # Run npm audit and filter the report
          critical_vulnerabilities=$(npm audit --audit-level=critical --json | jq '[.advisories[] | select(.severity == "critical")]')

          # Filter out ignored vulnerabilities
          for ignore in "${IGNORE_LIST[@]}"; do
            critical_vulnerabilities=$(echo $critical_vulnerabilities | jq "del(.[] | select(.cves[] | contains(\"$ignore\")))")
          done

          # Check if any critical vulnerabilities remain
          critical_count=$(echo $critical_vulnerabilities | jq 'length')

          if [ "$critical_count" -gt 0 ]; then
            echo "::error::Critical vulnerabilities detected: $critical_count vulnerabilities found."
            exit 1
          else
            echo "No critical vulnerabilities detected, or all critical vulnerabilities are ignored."
          fi
